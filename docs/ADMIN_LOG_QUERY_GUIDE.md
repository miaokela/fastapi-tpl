# Admin æ—¥å¿—æŸ¥è¯¢åŠŸèƒ½é›†æˆæŒ‡å—

## åŠŸèƒ½æ¦‚è¿°

åœ¨åå°ç®¡ç†ç³»ç»Ÿä¸­é›†æˆäº†æ—¥å¿—æŸ¥è¯¢åŠŸèƒ½ï¼Œæ”¯æŒï¼š
- ğŸ“„ é€‰æ‹©æŒ‡å®šæ—¥å¿—æ–‡ä»¶æŸ¥çœ‹
- ğŸ” ä½¿ç”¨ jq è¯­è¨€è¿›è¡Œå¼ºå¤§çš„æ—¥å¿—è¿‡æ»¤å’ŒæŸ¥è¯¢
- ğŸ“Š å°† JSON ç¬¬ä¸€å±‚å­—æ®µä»¥å•å…ƒæ ¼å½¢å¼å±•ç¤º
- ğŸ“ˆ æŸ¥çœ‹å®Œæ•´çš„ JSON æ ¼å¼åŒ–æ•°æ®è¯¦æƒ…
- ğŸ“‹ æä¾›å¤šä¸ªå®ç”¨çš„æŸ¥è¯¢ç¤ºä¾‹

## æŠ€æœ¯å®ç°

### åç«¯ API

**è·å–æ—¥å¿—æ–‡ä»¶åˆ—è¡¨**
```
GET /admin/logs/files
```

è¿”å›æ‰€æœ‰å¯ç”¨çš„æ—¥å¿—æ–‡ä»¶åˆ—è¡¨ï¼ˆæŒ‰æ—¥æœŸå€’åºï¼‰ã€‚

**æ‰§è¡Œæ—¥å¿—æŸ¥è¯¢**
```
POST /admin/logs/query?filename={filename}&jq_filter={filter}
```

å‚æ•°ï¼š
- `filename`: æ—¥å¿—æ–‡ä»¶åï¼ˆå¦‚ `2025-12-23.log`ï¼‰
- `jq_filter`: jq è¿‡æ»¤è¡¨è¾¾å¼ï¼ˆé»˜è®¤ä¸º `.`ï¼‰

è¿”å›ï¼š
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "filename": "2025-12-23.log",
    "jq_filter": "select(.user_id == 123)",
    "count": 15,
    "results": [
      {
        "created_at": "2025-12-23 10:30:45.123",
        "message": "ç”¨æˆ·ç™»å½•æˆåŠŸ",
        "user_id": 123,
        "username": "john"
      },
      ...
    ]
  }
}
```

### å‰ç«¯ç•Œé¢

1. **æ–‡ä»¶é€‰æ‹©é¢æ¿** - å·¦ä¾§åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„æ—¥å¿—æ–‡ä»¶
2. **æŸ¥è¯¢è¾“å…¥åŒº** - ç¼–å†™ jq è¿‡æ»¤è¡¨è¾¾å¼
3. **æŸ¥è¯¢ç¤ºä¾‹** - å¿«é€ŸæŒ‰é’®åŠ è½½å¸¸ç”¨æŸ¥è¯¢
4. **ç»“æœå±•ç¤º** - å³ä¾§æ˜¾ç¤ºæŸ¥è¯¢ç»“æœ
5. **è¯¦æƒ…æŸ¥çœ‹** - ç‚¹å‡»æŸ¥çœ‹æŒ‰é’®å±•å¼€å®Œæ•´ JSON

## æŸ¥è¯¢ç¤ºä¾‹

### 1. æŸ¥çœ‹æ‰€æœ‰è®°å½•
```jq
.
```

### 2. æŸ¥è¯¢ç‰¹å®šç”¨æˆ·
```jq
select(has("user_id") and .user_id == 123)
```

### 3. æ¨¡ç³ŠæŸ¥è¯¢æ¶ˆæ¯
```jq
select(.message | contains("æˆåŠŸ"))
```

### 4. æ—¶é—´èŒƒå›´æŸ¥è¯¢
```jq
select(.created_at >= "2025-12-23 10:00" and .created_at <= "2025-12-23 11:00")
```

### 5. æŒ‰æ¶ˆæ¯åˆ†ç»„ç»Ÿè®¡
```jq
group_by(.message) | map({message: .[0].message, count: length})
```

### 6. æ•°æ®åº“æ“ä½œæŸ¥è¯¢
```jq
select(has("operation") and .operation == "INSERT")
```

### 7. æŸ¥è¯¢è€—æ—¶æ“ä½œ
```jq
select(has("duration_ms") and .duration_ms > 10) | length
```

### 8. æŒ‰æ“ä½œç±»å‹åˆ†ç»„
```jq
select(has("operation")) | group_by(.operation) | map({operation: .[0].operation, count: length})
```

## æ—¥å¿—æ ¼å¼è¯´æ˜

æ‰€æœ‰æ—¥å¿—éƒ½æ˜¯ JSON æ ¼å¼ï¼ŒåŒ…å«ä»¥ä¸‹å¿…éœ€å­—æ®µï¼š
- `created_at`: æ—¥å¿—åˆ›å»ºæ—¶é—´ï¼ˆæ ¼å¼ï¼šYYYY-MM-DD HH:MM:SS.mmmï¼‰
- `message`: æ—¥å¿—æ¶ˆæ¯

å…¶ä»–å­—æ®µç”±è°ƒç”¨æ—¶çš„ `**kwargs` ä¼ å…¥ï¼Œä¾‹å¦‚ï¼š
```python
log_info("ç”¨æˆ·ç™»å½•æˆåŠŸ", user_id=123, username="john", ip="192.168.1.1")
```

å¯¹åº”çš„æ—¥å¿—æ¡ç›®ï¼š
```json
{
  "created_at": "2025-12-23 10:30:45.123",
  "message": "ç”¨æˆ·ç™»å½•æˆåŠŸ",
  "user_id": 123,
  "username": "john",
  "ip": "192.168.1.1"
}
```

## ä½¿ç”¨æ­¥éª¤

1. **ç™»å½•åå°ç®¡ç†ç³»ç»Ÿ** - éœ€è¦ç®¡ç†å‘˜æƒé™
2. **è¿›å…¥æ—¥å¿—æŸ¥è¯¢é¡µé¢** - å·¦ä¾§èœå• â†’ æ—¥å¿—æŸ¥è¯¢
3. **é€‰æ‹©æ—¥å¿—æ–‡ä»¶** - ä»ä¸‹æ‹‰èœå•é€‰æ‹©
4. **ç¼–å†™æˆ–é€‰æ‹©æŸ¥è¯¢** - è¾“å…¥ jq è¡¨è¾¾å¼æˆ–ç‚¹å‡»ç¤ºä¾‹æŒ‰é’®
5. **æ‰§è¡ŒæŸ¥è¯¢** - ç‚¹å‡»"æ‰§è¡ŒæŸ¥è¯¢"æŒ‰é’®
6. **æŸ¥çœ‹ç»“æœ** - ç»“æœä»¥å•å…ƒæ ¼å½¢å¼å±•ç¤º
7. **æŸ¥çœ‹è¯¦æƒ…** - ç‚¹å‡»"æŸ¥çœ‹è¯¦æƒ…"æŒ‰é’®æŸ¥çœ‹å®Œæ•´ JSON

## jq æŸ¥è¯¢è¯­è¨€å¿«é€Ÿå‚è€ƒ

### åŸºç¡€é€‰æ‹©
```jq
.                           # åŸæ ·è¾“å‡ºæ•´ä¸ªå¯¹è±¡
.field                      # è·å–ç‰¹å®šå­—æ®µ
.field.subfield             # åµŒå¥—å­—æ®µè®¿é—®
```

### æ¡ä»¶è¿‡æ»¤
```jq
select(.field == "value")   # ç­‰äº
select(.field != "value")   # ä¸ç­‰äº
select(.field > 100)        # å¤§äº
select(.field < 100)        # å°äº
select(.field | contains("text"))  # å­—ç¬¦ä¸²åŒ…å«
select(has("field"))        # å­—æ®µæ˜¯å¦å­˜åœ¨
```

### é€»è¾‘è¿ç®—
```jq
select(.a == 1 and .b == 2)    # AND é€»è¾‘
select(.a == 1 or .b == 2)     # OR é€»è¾‘
```

### æ•°æ®å¤„ç†
```jq
group_by(.field)            # æŒ‰å­—æ®µåˆ†ç»„
sort_by(.field)             # æŒ‰å­—æ®µæ’åº
reverse                     # åå‘æ’åº
unique                      # å»é‡
length                      # è·å–é•¿åº¦æˆ–æ•°é‡
map({...})                  # æ˜ å°„è½¬æ¢
```

### æ•°ç»„æ“ä½œ
```jq
.[0]                        # ç¬¬ä¸€ä¸ªå…ƒç´ 
.[0:10]                     # å‰10ä¸ªå…ƒç´ 
.[-1]                       # æœ€åä¸€ä¸ªå…ƒç´ 
```

## æ³¨æ„äº‹é¡¹

1. **å®‰å…¨æ€§** - API ç«¯ç‚¹éœ€è¦è¶…çº§ç®¡ç†å‘˜æƒé™
2. **æ–‡ä»¶è·¯å¾„** - è‡ªåŠ¨é˜²æ­¢è·¯å¾„éå†æ”»å‡»
3. **è¶…æ—¶ä¿æŠ¤** - jq æŸ¥è¯¢æœ‰ 10 ç§’è¶…æ—¶é™åˆ¶
4. **å¤§æ–‡ä»¶** - å¯¹äºéå¸¸å¤§çš„æ—¥å¿—æ–‡ä»¶ï¼Œä½¿ç”¨æ›´å…·ä½“çš„è¿‡æ»¤å™¨ä»¥æé«˜æ€§èƒ½

## å¸¸è§é—®é¢˜

**Q: ä¸ºä»€ä¹ˆæœ‰äº›æŸ¥è¯¢å¤±è´¥ï¼Ÿ**  
A: å¯èƒ½æ˜¯å› ä¸ºï¼š
- jq è¯­æ³•é”™è¯¯
- æ—¥å¿—æ–‡ä»¶ä¸­æ··æœ‰é JSON è¡Œ
- æŸ¥è¯¢å­—æ®µä¸å­˜åœ¨

**Q: å¦‚ä½•åªæŸ¥è¯¢æœ€è¿‘å‡ ä¸ªå°æ—¶çš„æ—¥å¿—ï¼Ÿ**  
A: ä½¿ç”¨æ—¶é—´èŒƒå›´è¿‡æ»¤ï¼š
```jq
select(.created_at >= "2025-12-23 14:00" and .created_at <= "2025-12-23 16:00")
```

**Q: å¦‚ä½•å¯¼å‡ºæŸ¥è¯¢ç»“æœï¼Ÿ**  
A: å³é”®ç‚¹å‡»ç»“æœåŒºåŸŸï¼Œä½¿ç”¨æµè§ˆå™¨çš„"Save as"åŠŸèƒ½ä¿å­˜ä¸º JSON æ–‡ä»¶ã€‚

## æ–‡ä»¶ä½ç½®

- **API å®ç°**: `app/admin/admin_views.py` (ç¬¬ 634-713 è¡Œ)
- **å‰ç«¯ HTML**: `static/admin/index.html` (æ—¥å¿—æŸ¥è¯¢é¡µé¢)
- **å‰ç«¯ JavaScript**: `static/admin/js/app.js` (æ—¥å¿—æŸ¥è¯¢é€»è¾‘)
- **å‰ç«¯ CSS**: `static/admin/css/style.css` (æ—¥å¿—æŸ¥è¯¢æ ·å¼)
- **æ—¥å¿—ç›®å½•**: `logs/` (æŒ‰æ—¥æœŸå­˜å‚¨çš„æ—¥å¿—æ–‡ä»¶)

## ç¤ºä¾‹åœºæ™¯

### åœºæ™¯1: æ’æŸ¥ç‰¹å®šç”¨æˆ·çš„é—®é¢˜
```jq
select(has("user_id") and .user_id == 123)
```

### åœºæ™¯2: æŸ¥æ‰¾æ‰€æœ‰å¤±è´¥çš„æ“ä½œ
```jq
select(.message | contains("å¤±è´¥"))
```

### åœºæ™¯3: æ€§èƒ½åˆ†æ - æ‰¾å‡ºè€—æ—¶æœ€é•¿çš„æ“ä½œ
```jq
select(has("duration_ms")) | sort_by(.duration_ms) | reverse | .[0:5]
```

### åœºæ™¯4: è·å–ç»Ÿè®¡ä¿¡æ¯ - æŒ‰æ“ä½œç±»å‹ç»Ÿè®¡
```jq
select(has("operation")) | group_by(.operation) | map({operation: .[0].operation, count: length})
```

### åœºæ™¯5: ç”ŸæˆæŠ¥è¡¨ - è·å–ç‰¹å®šæ—¶é—´æ®µçš„æ‰€æœ‰æ•°æ®åº“æ“ä½œ
```jq
select(
  has("operation") and 
  .created_at >= "2025-12-23 00:00" and 
  .created_at < "2025-12-24 00:00"
)
```
