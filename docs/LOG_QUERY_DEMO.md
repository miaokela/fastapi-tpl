#!/usr/bin/env python
"""
日志查询功能演示脚本

使用此脚本来演示日志查询功能的各种用法
"""

# 演示场景 1: 查看最近生成的日志
print("""
================================================
演示场景 1: 查看最近的日志文件
================================================

进入后台管理系统 → 日志查询
- 日志文件选择: 2025-12-23.log
- jq 过滤器: .
- 结果: 显示所有日志条目，每条占一行

""")

# 演示场景 2: 查询特定用户
print("""
================================================
演示场景 2: 追踪特定用户的所有操作
================================================

用户故障排查场景：user_id=123 在今天遇到了问题

步骤:
1. 选择日志文件: 2025-12-23.log
2. 点击查询示例: "特定用户查询"
3. 自动填充: select(has("user_id") and .user_id == 123)
4. 点击"执行查询"

结果: 看到该用户的所有日志记录（登录、数据库操作等）
每条记录显示关键字段：
- created_at: 操作时间
- message: 操作描述
- user_id: 用户ID
- 其他相关字段

点击"查看详情"查看完整的 JSON 数据

""")

# 演示场景 3: 模糊搜索
print("""
================================================
演示场景 3: 模糊搜索日志（关键词搜索）
================================================

查找所有"成功"的操作

步骤:
1. 选择日志文件: 2025-12-23.log
2. 点击查询示例: "模糊查询-成功"
3. 自动填充: select(.message | contains("成功"))
4. 点击"执行查询"

结果: 只显示消息中包含"成功"的记录

这对于快速找出系统中哪些操作成功完成很有用。

""")

# 演示场景 4: 时间范围查询
print("""
================================================
演示场景 4: 查询特定时间段的日志
================================================

分析 10:30-11:30 这一小时内的所有操作

步骤:
1. 选择日志文件: 2025-12-23.log
2. 点击查询示例: "时间范围查询"
3. 根据需要修改时间范围
4. 点击"执行查询"

示例查询:
select(.created_at >= "2025-12-23 10:30" and .created_at <= "2025-12-23 11:30")

结果: 只显示该时间段内的所有操作

用于性能分析、流量分析、故障时间定位等

""")

# 演示场景 5: 数据库操作统计
print("""
================================================
演示场景 5: 统计数据库操作（分组统计）
================================================

了解今天有多少INSERT、UPDATE、DELETE操作

步骤:
1. 选择日志文件: 2025-12-23.log
2. 点击查询示例: "按消息分组统计"
3. 或输入自定义查询
4. 点击"执行查询"

示例查询统计按操作类型:
select(has("operation")) | group_by(.operation) | map({operation: .[0].operation, count: length})

结果: 显示统计结果
- INSERT: 45 次
- UPDATE: 28 次
- DELETE: 12 次

用于性能优化、操作监控

""")

# 演示场景 6: 耗时操作分析
print("""
================================================
演示场景 6: 找出性能问题（查询耗时操作）
================================================

发现系统哪些操作耗时最长

步骤:
1. 选择日志文件: 2025-12-23.log
2. 点击查询示例: "数据库INSERT操作"
3. 修改查询以找出耗时操作
4. 点击"执行查询"

查询耗时超过 50ms 的操作:
select(has("duration_ms") and .duration_ms > 50)

结果:
- 显示所有耗时操作
- 可以看到是哪些操作、用户、耗时多少
- 点击查看详情看完整数据

这帮助你优化性能瓶颈

""")

# 演示场景 7: 对数据字段
print("""
================================================
演示场景 7: 单元格网格显示
================================================

日志查询结果展示形式:

每条日志记录显示为一个网格：

┌──────────────┬──────────────┬──────────────┐
│ created_at   │ message      │ user_id      │
│ 2025-12-23.. │ 用户登录成功 │ 123          │
│ 10:30:45.123 │              │              │
└──────────────┴──────────────┴──────────────┘

┌──────────────┬──────────────┬──────────────┐
│ username     │ ip           │ ...          │
│ john         │ 192.168.1.1  │              │
└──────────────┴──────────────┴──────────────┘

特点:
- 每个字段占一个单元格
- 自动根据类型着色（字符串绿色、数字黄色）
- 长字符串自动截断
- 点击"查看详情"展开完整 JSON

""")

# 演示场景 8: 完整 JSON 详情
print("""
================================================
演示场景 8: 查看完整的 JSON 详情
================================================

点击每条记录的"查看详情"按钮，弹出模态框显示：

{
  "created_at": "2025-12-23 10:30:45.123",
  "message": "用户登录成功",
  "user_id": 123,
  "username": "john",
  "ip": "192.168.1.1",
  "operation": "SELECT",
  "table": "users",
  "duration_ms": 12.5,
  "rows": 1,
  ...更多字段
}

可以：
- 查看原始数据（格式化后）
- 复制完整 JSON
- 导出为文件（浏览器右键菜单）

""")

# 高级用法
print("""
================================================
高级用法: 复杂查询
================================================

组合多个条件:

1. 查询特定用户在特定时间的数据库操作:
   select(
     .user_id == 123 and 
     has("operation") and 
     .created_at >= "2025-12-23 10:00" and 
     .created_at < "2025-12-23 11:00"
   )

2. 按操作类型和用户分组统计:
   group_by([.operation, .user_id]) | 
   map({
     operation: .[0].operation,
     user_id: .[0].user_id,
     count: length
   })

3. 找出特定用户在特定操作中的耗时:
   select(.user_id == 123 and has("duration_ms")) | 
   sort_by(.duration_ms) | 
   reverse | 
   .[0:10]

4. 生成日报统计:
   group_by(.message) | 
   map({
     event: .[0].message,
     count: length,
     users: map(.user_id) | unique | length
   })

""")

# 最佳实践
print("""
================================================
最佳实践
================================================

1. 从简单查询开始
   - 先用 "." 查看原始数据
   - 理解数据结构后再写过滤器

2. 使用具体的过滤条件
   - 特别是大日志文件
   - 可以加快查询速度

3. 利用查询示例
   - 8 个常用查询示例
   - 可以直接使用或修改

4. 查看完整详情
   - 单元格视图用于快速浏览
   - 详情视图用于深度分析

5. 组合多个条件
   - 使用 AND / OR 逻辑
   - 可以实现复杂查询

6. 定期清理日志
   - 系统自动保留 7 天
   - 可配置保留时间

""")

print("""
================================================
查询示例速查表
================================================

点击快速查询按钮:

[查看所有记录]              →  .
[今天的日志]                →  select(.created_at | contains("2025-12-23"))
[模糊查询-成功]             →  select(.message | contains("成功"))
[特定用户查询]              →  select(has("user_id") and .user_id == 123)
[按消息分组统计]            →  group_by(.message) | map({message: .[0].message, count: length})
[时间范围查询]              →  select(.created_at >= "..." and .created_at <= "...")
[数据库INSERT操作]          →  select(has("operation") and .operation == "INSERT")
[耗时大于10ms的操作数]     →  select(has("duration_ms") and .duration_ms > 10) | length

================================================
""")
